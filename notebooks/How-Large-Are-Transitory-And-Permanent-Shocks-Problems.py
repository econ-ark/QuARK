# ---
# jupyter:
#   jupytext:
#     cell_metadata_filter: ExecuteTime,-autoscroll,collapsed
#     cell_metadata_json: true
#     formats: ipynb,py:percent
#     notebook_metadata_filter: all,-widgets,-varInspector
#     text_representation:
#       extension: .py
#       format_name: percent
#       format_version: '1.3'
#       jupytext_version: 1.11.5
#   kernelspec:
#     display_name: Python 3
#     language: python
#     name: python3
#   language_info:
#     codemirror_mode:
#       name: ipython
#       version: 3
#     file_extension: .py
#     mimetype: text/x-python
#     name: python
#     nbconvert_exporter: python
#     pygments_lexer: ipython3
#     version: 3.8.8
# ---

# %% [markdown]
# # How Large Are Transitory and Permanent Shocks?
#
# This notebook illustrates a simple method for measuring the size of transitory and permanent shocks for a set of households whose incomes are subject to those kinds of shocks

# %% {"code_folding": [], "jupyter": {"source_hidden": true}, "tags": []}
# This cell has a bit of initial setup.
# You should substitute whatever setup you might need to address the questions below
import matplotlib.pyplot as plt
import numpy as np
import HARK
from copy import deepcopy
from HARK.utilities import plot_funcs

# %% [markdown]
# ## Income Process With Transitory and Permanent Shocks
#
# Assume that a household observes two income shocks at the beginning of each period.  Permanent income would be expected to grow by a factor $\Gamma_{t+1}$ in the absence of any shock (this could capture a life cycle profile of income, for example) but that growth is modified by a shock, $\Psi_{t+1}$:
# \begin{align}
#  P_{t+1} & = \Gamma_{t+1} P_{t}\Psi_{t+1}
# \end{align}
# whose expected (mean) value is $\mathbb{E}_{t}[\Psi_{t+1}]=1$.  Actual income received $Y$ is equal to permanent income $P$ multiplied by a transitory shock $\Theta$:
# \begin{align}
#  Y_{t+1} & = P_{t+1}\Theta_{t+1}
# \end{align}
# where again $\mathbb{E}_{t}[\Theta_{t+1}] = 1$.

# %% [markdown]
# For present purposes, we assume that the transitory and permanent shocks are independent.  The transitory shock has two components: A probability $\wp$ that the consumer is unemployed, in which case $\theta^{u}=\theta$, and a probability $(1-\wp)$ of a shock that is a lognormal with a mean chosen so that $\mathbb{E}_{t}[\theta_{t+n}]=1$.
#
# Using lower case variables for the logarithms of all variables above, the process can be written more conveniently as:
#
# \begin{align}
#  p_{t+1} & = \gamma_{t+1} + p_{t} + \psi_{t+1}
# \\ y_{t+1} & = p_{t+1} + \theta_{t+1}
# \end{align}
# where both lower-case Greek shocks are now white noise IID variables.
#
# ### Removing the Predictable Components
#
# In actual microeconomic data, the first step is to remove the predictable components of income growth (since we are interested here in the shocks).  This is traditionally done by estimating a model of income growth.  Restricting the sample to people of working age, one simply performs a regression:
#
# \begin{align}
#  y_{i} & = X_{i} \zeta + \epsilon_{i}
# \end{align}
#
# where person $i$ is characterized by observable variables $X_{i}$ in a given period, where $X$ includes usual variables like age, education, and other characteristics known to the person well in advance of the realization of income in the period in question.  The result is an estimate $\hat{\zeta}$ of the consequences of the exogenous variables $X$.  The predictable component of income growth is then obained from
# \begin{align}
#  \hat{\gamma}_{t,i} & = X_{t,i} \hat{\zeta}.
# \end{align}
#
# ### Estimating The Variances 
#
# It will be notationally convenient to continue using the same variable names as before, where from here on out they are interpreted as having had the predictable component of income growth $\hat{\gamma}X_{t}$ removed.  That is, dropping the $i$ subscripts for simplicity,  we will assume that we now have data generated by a process like:
# \begin{align}
#  p_{t+1} & = p_{t} + \psi_{t+1}
# \\ y_{t+1} & = p_{t+1} + \theta_{t+1}
# \end{align}
#
# We can calculate a $d-$period difference in income as
# \begin{align}
#   y_{t+d} - y_{t} & = p_{t+d} - p_{t} + \theta_{t+d} - \theta_{t}
# \\ & =   \psi_{t+1} + \psi_{t+2} + ... \psi_{t+d} + \theta_{t+d} - \theta_{t}
# \end{align}
# and then we simply take the square of this to obtain:
# \begin{align}
#   (\Delta^{d}y)^{2} & = \left(\psi_{t+1} + \psi_{t+2} + ... \psi_{t+d} + \theta_{t+d} - \theta_{t}\right)^{2}
# \end{align}
# but since we have assumed that the $\psi$ and $\theta$ shocks are mutually and serially uncorrelated, the expectation of this simply becomes 
# \begin{align}
#   \mathbb{E}_{t}[(\Delta^{d}y)^{2}] & = \mathbb{E}_{t}[\psi_{t+1}^{2} + ... + \psi_{t+d}^{2} + 2 \theta^{2}]
# \\ & = d \sigma^{2}_{\psi} + 2 \sigma^{2}_\theta.
# \end{align}
#
# $(\Delta^{d}y)^{2}_{i}$ is an object that we can compute for any individual household.  We can then obtain an estimate of $\sigma^{2}_{\psi}$ and $2 \sigma^{2}_\theta$ by calculating a set of squared differences in log income for all our households, and performing a very simple regression:
# \begin{align}
#   (\Delta^{d}y)^{2}_{i} & = \eta_{0} + d \eta_{1}
# \end{align}
# where $\eta_{1} = \sigma^{2}_{\psi}$ and $\eta_{0} = 2 \sigma^{2}_{\theta}$.
#
#
# ### The Intuition
#
# The intuition for this approach is pretty compelling:  Essentially, the consequence of permanent shocks is to make people get more and more different from each other continually over time as they accumulate permanent shocks.  So the degree to which the _changes_ in income keep increasing and increasing as time passes is a direct measure of the magnitude of the permanent shocks that are causing that divergence.  
#
# If there were no permanent shocks, then in year $t$ and in year $t+d$ the person will have experienced transitory shocks $\theta_{t}$ and $\theta_{t+d}$.  But the very _definition_ of "transitory" means that none of the shocks in intervening periods has any consequence for the difference in incomes between $t$ and $t+d$.  Only the two transitory shocks of those two years contribute.
#
# ### A Caveat
#
# #### Time Aggregation
#
# If our data are measured at an annual frequency but income shocks can happen at any time during the year, then even if all shocks were permanent, an exercise like the one above, if conducted using annual data and using only three years of data (so, differences $\Delta^{1}$ and $\Delta^{2}$), would generate a biased answer due to the "time aggregation" problem ([Holbrook Working (1960)](doi:10.2307/1907574Copy); [Edmund Crawley (2020)](https://doi.org/10.1016/j.econlet.2020.108998).  Briefly, imagine two people who are identical up to the beginning of year $t$.  And they both experience identically sized shocks to permanent income in period $t$ -- but one experiences the shock on January 1, and the other on October 1.  Thus, the first person's income is boosted for the entire year by the shock; for this person, the method above would work.  But for the second person, only (1/4) of the year was spent earning the permanently higher level of income.  They would show some increment of income for the year $t$, but then would spend all of year $t+1$ at the higher level of income.  So, there would be a small change in income in year $t$ followed by a (predictable) larger increase in year $t+1$ -- which _looks like_ serial correlation in income growth.  In particular, this problem would manifest itself in a spurious first-order moving average (MA) component in a time series estimation that allowed for such a component.
#
# It can be shown that the problem goes away if only spans of years 2 or more are used.  That is, we have no problem if we use $\Delta^{3}$, $\Delta^{4}$, etc.  Indeed, it can be shown that the magnitude of the permanent shock can be estimated even when there is a _true_ MA component to the transitory shock, simply by restricting the data used to those that span intervals long enough for the MA component to have disappeared.

# %% [markdown]
# # PROBLEM: Simulate and Estimate 
#
# The $\texttt{ConsIndShockModel}$ consumer type is hard-wired to experience permanent and transitory income shocks exactly like those described above.  
#
# 1. Construct a population of `ConsIndShockModel` consumers and simulate them
#    * Use the default parameter values
# 1. For each simulated household $i$, compute an estimate of $(\hat{\sigma}^{2}_{\psi})_{i}$ and $(\hat{\sigma}^{2}_{\theta})_{i}$
#    * For any individual household, this will be a very noisy estimate
# 1. Calculate a population estimate of 
#    * Construct estimates of the 'true' values of $\sigma_{\psi}$ and $\sigma^{2}_{\theta}$ from the averages of the (very) noisy idiosyncratic numbers
#    * For example, $\hat{\sigma}^{2}_{\psi} = (1/I) \sum_{i=1}^{I} (\sigma^{2}_{\psi})_{i}$
# 1. Calculate the covariance of the household-level estimates of $(\hat{\sigma}^{2}_{\psi})_{i}$ and $(\hat{\theta}^{2}_{\psi})_{i}$
#    * Explain why these have a negative covariance
# 1. Experiment to determine how large a population of consumers, and how long a span of time, you need to correctly recover reliable estimates of the 'true' parameter values for the income process

# %% [markdown] {"tags": []}
# #### A Lower Bound on $p$
#
# The process above assumes that permanent income can wander to arbitrarily large or small values.  But in practice, all countries that are sophisticated enough to have household datasets of the kind needed to measure these shocks, also have some degree of social insurance that prevents income from falling below some "necessity" level of income.  It can be shown that, if measured income is bounded below (cannot fall too far), then the estimated magnitude of the permanent shocks will be biased down and estimates of the magnitude of the transitory shock will be biased up.

# %% [markdown]
# # PROBLEM: Effects Of a Lower Bound on $p$
#
# 1. Simulate a population in which there is a lower bound on $p$
# 1. Describe the circumstances under which the lower bound will cause a bias in the estimates of the transitory and permanent shocks
# 1. For a calibration under which there is significant bias, discuss why an income process in which the econometrician allows for merely persistent shocks might appear to fit the data better than one that assumes permanent shocks.
#     * That is, an econometrician who assumes the process for $p$ is 
#     \begin{equation}
#         p_{t+1} = \nu p_{t}+ \psi_{t+1}
#         \end{equation}
#     will estimate $\nu < 1$
